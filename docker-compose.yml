services:
  nginx:
    image: nginx:1.27-alpine
    ports:
      - "8080:80"
    volumes:
      # Nginx only needs the public/ tree + uploads (served via /uploads).
      - ./public:/var/www/html/public:ro
      - uploads_data:/var/www/html/storage/uploads:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - php

  php:
    build:
      context: ./docker/php
    volumes:
      - ./:/var/www/html
      - uploads_data:/var/www/html/storage/uploads
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_URL: ${APP_URL:-http://localhost:8080}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME:-dueldesk}
      DB_USER: ${DB_USER:-dueldesk}
      DB_PASSWORD: ${DB_PASSWORD:-dueldesk}
      DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:-}
      DISCORD_CLIENT_SECRET: ${DISCORD_CLIENT_SECRET:-}
      DISCORD_REDIRECT_URI: ${DISCORD_REDIRECT_URI:-}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID:-}
      DISCORD_ROLE_ID_PARTICIPANT: ${DISCORD_ROLE_ID_PARTICIPANT:-}
      DISCORD_WEBHOOK_URL: ${DISCORD_WEBHOOK_URL:-}
      BOT_API_TOKEN: ${BOT_API_TOKEN:-}
    depends_on:
      - db

  discord-bot:
    build:
      context: ./docker/discord-bot
    environment:
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      DISCORD_GUILD_ID: ${DISCORD_GUILD_ID:-}
      BOT_API_TOKEN: ${BOT_API_TOKEN:-}
      BOT_INTERNAL_URL: ${BOT_INTERNAL_URL:-http://nginx}
      BOT_PUBLIC_URL: ${APP_URL:-http://localhost:8080}
      BOT_POLL_SECONDS: ${BOT_POLL_SECONDS:-30}
      BOT_REMIND_COOLDOWN_SECONDS: ${BOT_REMIND_COOLDOWN_SECONDS:-600}
    depends_on:
      - nginx

  db:
    image: mariadb:11.4
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      MARIADB_DATABASE: ${DB_NAME:-dueldesk}
      MARIADB_USER: ${DB_USER:-dueldesk}
      MARIADB_PASSWORD: ${DB_PASSWORD:-dueldesk}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3306"

volumes:
  db_data:
  uploads_data:
