services:
  # Use this override when the VPS already has a reverse proxy on :80/:443
  # (nginx/traefik/caddy/nginx-proxy-manager, etc.).
  #
  # DuelDesk will be reachable only on localhost:${DUELDESK_HTTP_PORT:-8081}
  # and should be reverse-proxied by the existing front proxy.
  nginx:
    ports:
      # If your front reverse proxy runs in Docker and can't reach host 127.0.0.1,
      # set DUELDESK_BIND_IP=0.0.0.0 (and lock it down with firewall rules).
      - "${DUELDESK_BIND_IP:-127.0.0.1}:${DUELDESK_HTTP_PORT:-8081}:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10

  php:
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "php -r \"echo 'ok';\" >/dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5

  discord-bot:
    profiles: ["discord"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -e \"process.exit(0)\" >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  db:
    ports: [] # never expose MariaDB publicly
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h 127.0.0.1 -uroot -p$$MARIADB_ROOT_PASSWORD >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
